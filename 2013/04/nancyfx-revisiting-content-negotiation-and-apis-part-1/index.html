<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2013-08-03T16:21:53.1781387+08:00" />
    <title>philliphaydon.com</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="philliphaydon.com" rel="home">philliphaydon.com</a></h1>
                <h2><small>Works on my PC...</small></h2>
                <p class="site-description">Pleb from New Zealand who was banished overseas and currently resides in Singapore.</p>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/rss">RSS</a> / <a href="/feed">Atom</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<div id="post">
    <h1>NancyFX - Revisiting Content Negotiation &amp; APIs (Part 1)</h1>

    <div class="post-note">
      posted on 22 Apr 2013
       | <a href="/category/nancyfx">NancyFX</a>
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
        
    &lt;ul&gt;
&lt;li&gt;Original Post: &lt;a href=&quot;/2012/11/nancy-and-content-negotiation&quot;&gt;NancyFX and Content Negotiation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;NancyFX - Revisiting Content Negotiation &amp;amp; APIs (Part 1)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-2/&quot;&gt;NancyFX - Revisiting Content Negotiation &amp;amp; APIs (Part 2)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-3/&quot;&gt;NancyFX - Revisiting Content Negotiation &amp;amp; APIs (Part 3)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I thought I would revisit this topic since I don't believe I did it enough justice last time around, and I believe it really is important when creating an API that is going to be consumed not only by the public or client, but &lt;strong&gt;by you also&lt;/strong&gt;!&lt;/p&gt;

&lt;p&gt;When the browser asks for &lt;code&gt;text/html&lt;/code&gt; its negotiating with the server. So really your website is an API, your &lt;code&gt;Views&lt;/code&gt; are just an additional type of content that your API serves up when requested.&lt;/p&gt;

&lt;h2&gt;Example&lt;/h2&gt;

&lt;p&gt;Lets say you're building Twitter, the initial page shows a list of tweets, so the browser makes a call to &lt;code&gt;/tweets&lt;/code&gt; and the server responds with a list of tweets rendered with using HTML.&lt;/p&gt;

&lt;p&gt;Once the page has loaded, the client uses JavaScript to load new tweets, so it calls &lt;code&gt;/tweets&lt;/code&gt; again, this time it returns a &lt;code&gt;json&lt;/code&gt; result, and the client-side templating engine then renders and appends those to the top of the existing list, keeping the client up to date with the latest tweets.&lt;/p&gt;

&lt;p&gt;What's nice is no new data needed to be written on the server! &lt;/p&gt;

&lt;!--excerpt--&gt;

&lt;p&gt;&lt;span class=&quot;note&quot;&gt;&lt;strong&gt;Note:&lt;/strong&gt; I'm not going to discuss RESTful API's, that would just create too many arguments.&lt;/span&gt;&lt;/p&gt;

&lt;h2&gt;Need code please&lt;/h2&gt;

&lt;p&gt;Right so lets see this in action for real. When I demonstrated this in my previous post, I showed a somewhat complicated Negotiate, this time I'm going to show a super simple scenario.&lt;/p&gt;

&lt;p&gt;We have a &lt;code&gt;ProductsModule&lt;/code&gt;, it can &lt;code&gt;Get&lt;/code&gt; a single product, or it can &lt;code&gt;Get&lt;/code&gt; a list of products.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public class ProductsModule : NancyModule
{
    public ProductsModule(IProductRepository productRepository)
        :base(&quot;products&quot;)
    {
        Get[&quot;/{id}&quot;] = _ =&amp;gt;
        {
            var product = productRepository.Get((int)_.id);

            return product;
        };

        Get[&quot;/&quot;] = _ =&amp;gt;
        {
            var products = productRepository.List();

            return products;
        };
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using a Chrome Plugin called Postman which can be found on the &lt;a href=&quot;https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?utm_source=chrome-ntp-launcher&quot;&gt;Chrome Web Store&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-1.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can invoke some calls to get some data. We specify the &lt;code&gt;URL&lt;/code&gt;, the &lt;code&gt;VERB&lt;/code&gt;, and add some Headers. In this case we will add a single header. &lt;code&gt;Accept&lt;/code&gt; where we specify that we want &lt;code&gt;application/xml&lt;/code&gt;. &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When we invoke this, we get an XML result of our products:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-3.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When we do the same call but we specify the &lt;code&gt;Accept&lt;/code&gt; header with &lt;code&gt;application/json&lt;/code&gt; we get a JSON result. &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-4.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nice right? So far we haven't written any code other than returning some data to a endpoint we specified. Lets take a look at the first route, its a Get By Id route, and all we're returning is a single Product.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-5.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now if we specify the Accept as something the browser would ask for, &lt;code&gt;text/html&lt;/code&gt; we would expect rendered HTML.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-6.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Bam we get an error, but this is only because the view doesn't exist yet. By default NancyFX looks for a view of the same name of the type returned.&lt;/p&gt;

&lt;p&gt;Since we returned a 'product', the view name that Nancy will look for is &lt;code&gt;typeof(Product).Name&lt;/code&gt; or &lt;code&gt;Product&lt;/code&gt;. So if we create a new product view to display some data:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html lang=&quot;en&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&amp;gt;
&amp;lt;head&amp;gt;
    &amp;lt;meta charset=&quot;utf-8&quot; /&amp;gt;
    &amp;lt;title&amp;gt;&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;

    &amp;lt;div&amp;gt;
        Id: [ERR!]
        &amp;lt;br /&amp;gt;
        Name: [ERR!]
        &amp;lt;br /&amp;gt;
        Price: $[ERR!]
    &amp;lt;/div&amp;gt;

&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Super super simple, now when we call the same route again we get:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-7.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now we have a Single API that returns JSON, XML, or HTML. &lt;/p&gt;

&lt;h2&gt;Fiddly Issues&lt;/h2&gt;

&lt;p&gt;Here's where things get fiddly, if we want to return the collection with a view, NancyFX will attempt to convert the &lt;code&gt;List&amp;lt;Product&amp;gt;&lt;/code&gt; to it's name, and look for the view. This ends up looking for a view by the name of &lt;code&gt;List`1&lt;/code&gt;, which you may think will fail, but funnily enough you can actually create a view with the backquote.&lt;/p&gt;

&lt;p&gt;So lets create a new file called &lt;code&gt;List`1.sshtml&lt;/code&gt; and populate it with some basic HTML:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;!DOCTYPE html&amp;gt; 
&amp;lt;html lang=&quot;en&quot; xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&amp;gt;
&amp;lt;head&amp;gt;
    &amp;lt;meta charset=&quot;utf-8&quot; /&amp;gt;
    &amp;lt;title&amp;gt;&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;

    [ERR!]

&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;span class=&quot;note&quot;&gt;&lt;strong&gt;Note:&lt;/strong&gt; in case you're wondering, this isn't Razor, this is Nancy's Super Simple View Engine :)&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Now if we run up the site again and hit &lt;code&gt;/products&lt;/code&gt; we get:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/nancyfx-conneg-updated-8.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2&gt;Recap&lt;/h2&gt;

&lt;p&gt;So far we have created a single endpoint with very little code that can respond with JSON/XML/HTML. Next I'm going to show how &lt;code&gt;Negotiate&lt;/code&gt; gives you more flexibility.&lt;/p&gt;


	<div class="divider"></div>
	<div id="disqus_thread"></div>
	<script>
	    var disqus_shortname = 'philliphaydon';
	    var disqus_url = "http://www.philliphaydon.com@Model.Url";

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function () {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51ca97356d8c1454"></script>

</div>
                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->

            <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
                <aside id="text-5" class="widget widget_text">
                    <h1 class="widget-title">Follow</h1>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="http://stackoverflow.com/users/456813/phill" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                        <a href="http://www.linkedin.com/in/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://plus.google.com/u/0/111751877537461442095" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        <a href="https://coderbits.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','https://coderbits.com/philliphaydon']);"><img src="/stylesheets/images/codebits.png"></a>
                        <a href="https://github.com/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                        <a href="http://www.codeschool.com/users/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://codeschool.com']);"><img src="/stylesheets/images/codeschool.png"></a>
                        <a href="http://www.kickstarter.com/profile/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://kickstarter.com']);"><img src="/stylesheets/images/kickstarter.png"></a>
                    </div>
                    <a href="http://stackoverflow.com/users/456813/phill">
                      <img src="http://stackoverflow.com/users/flair/456813.png" width="208" height="58" alt="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                    </a>
                    
                    <a href="http://nancyfx.org/mvm.html"><img src="/stylesheets/images/mvm.png"></a>
                    
                    <div id = "clustrback" style="width:162px; height:133px;  background:#f7f7f7 url(http://clustrmaps.com/admin/3d/images/st4_grey.png)  center no-repeat; text-align:center;">
                      <a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.philliphaydon.com/" style="width:160px; display:block; margin:0 auto;" id="clustrMapsLink">
                        <img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.philliphaydon.com/" style="border:0px; margin:15px auto;margin:15px auto;" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" />
                      </a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="linkcat-6" class="widget widget_links">
                    <h1 class="widget-title">Other Blogs</h1>
                    <ul class='xoxo blogroll'>
                        <li><a href="http://www.nickharris.net/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://nickharris.net/']);">Nick Harris</a></li>
                        <li><a href="http://www.mindscapehq.com/blog/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.mindscapehq.com/blog/']);">Mindscape</a></li>
                        <li><a href="http://blog.orangelightning.co.uk/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://blog.orangelightning.co.uk/']);">Phil Jones</a></li>
                        <li><a href="http://buildstarted.com/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://buildstarted.com']);">Ben Dornis</a></li>
                        <li><a href="http://jflood.net/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://jflood.net/']);">Jospeh Flood</a></li>
                    </ul>
                    
                </aside>
                <aside id="archives-4" class="widget widget_archive">
                    <h1 class="widget-title">Archive</h1>
                    <ul class="posts">
                          <li><a href="/archive#2013August">August, 2013</a></li>
                          <li><a href="/archive#2013July">July, 2013</a></li>
                          <li><a href="/archive#2013June">June, 2013</a></li>
                          <li><a href="/archive#2013May">May, 2013</a></li>
                          <li><a href="/archive#2013April">April, 2013</a></li>
                          <li><a href="/archive#2013March">March, 2013</a></li>
                          <li><a href="/archive#2013February">February, 2013</a></li>
                          <li><a href="/archive#2013January">January, 2013</a></li>
                          <li><a href="/archive#2012December">December, 2012</a></li>
                          <li><a href="/archive#2012November">November, 2012</a></li>
                          <li><a href="/archive#2012October">October, 2012</a></li>
                          <li><a href="/archive#2012September">September, 2012</a></li>
                          <li><a href="/archive#2012July">July, 2012</a></li>
                          <li><a href="/archive#2012June">June, 2012</a></li>
                          <li><a href="/archive#2012April">April, 2012</a></li>
                          <li><a href="/archive#2012March">March, 2012</a></li>
                          <li><a href="/archive#2012February">February, 2012</a></li>
                          <li><a href="/archive#2012January">January, 2012</a></li>
                          <li><a href="/archive#2011December">December, 2011</a></li>
                          <li><a href="/archive#2011November">November, 2011</a></li>
                          <li><a href="/archive#2011October">October, 2011</a></li>
                          <li><a href="/archive#2011September">September, 2011</a></li>
                          <li><a href="/archive#2011August">August, 2011</a></li>
                          <li><a href="/archive#2011July">July, 2011</a></li>
                          <li><a href="/archive#2011June">June, 2011</a></li>
                          <li><a href="/archive#2011May">May, 2011</a></li>
                          <li><a href="/archive#2011April">April, 2011</a></li>
                          <li><a href="/archive#2011March">March, 2011</a></li>
                          <li><a href="/archive#2011February">February, 2011</a></li>
                          <li><a href="/archive#2011January">January, 2011</a></li>
                          <li><a href="/archive#2010December">December, 2010</a></li>
                          <li><a href="/archive#2010November">November, 2010</a></li>
                          <li><a href="/archive#2010October">October, 2010</a></li>
                          <li><a href="/archive#2010September">September, 2010</a></li>
                          <li><a href="/archive#2009July">July, 2009</a></li>
                    </ul>
                </aside>
            </div>
            <!-- #secondary .widget-area -->


        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    <!--script src='http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js' type='text/javascript'></script-->
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-655975-13']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
